# JULEA - Flexible storage framework
# Copyright (C) 2017-2024 Michael Kuhn
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.


spack_clone ()
{
	local spack_packages_commit

	spack_packages_commit='9ca712a716ef98dcc39e3a76b5e5b6b1aa89746e'

	test -n "${JULEA_SPACK_DIR}" || return 1

	if test ! -d "${JULEA_SPACK_DIR}"
	then
		git clone --config feature.manyFiles=true --depth=1 --branch=releases/v1.0 https://github.com/spack/spack.git "${JULEA_SPACK_DIR}"
	fi

	test -d "${JULEA_SPACK_DIR}" || return 1

	if test ! -d "${JULEA_SPACK_DIR}/packages"
	then
		git clone --config feature.manyFiles=true --branch=develop https://github.com/spack/spack-packages.git "${JULEA_SPACK_DIR}/packages"
	fi

	test -d "${JULEA_SPACK_DIR}/packages" || return 1

	(
		cd "${JULEA_SPACK_DIR}/packages" || return 1

		git fetch
		git reset --hard "${spack_packages_commit}"
	)


	return 0
}

spack_init ()
{
	local spack_env

	test -n "${JULEA_SPACK_DIR}" || return 1
	test -d "${JULEA_SPACK_DIR}" || return 1

	spack_env="${JULEA_SPACK_DIR}/share/spack/setup-env.sh"

	test -f "${spack_env}" || return 1

	# shellcheck source=/dev/null
	. "${spack_env}"

	return 0
}

spack_set_env ()
{
	test -n "${JULEA_SPACK_DIR}" || return 1

	export SPACK_DISABLE_LOCAL_CONFIG=true
	# FIXME maybe put into /tmp in CI
	export SPACK_USER_CACHE_PATH="${JULEA_SPACK_DIR}/cache"
}

spack_install_dependencies()
{
	# FIXME does not fail if Git is not installed
	if spack_clone && spack_init && spack_set_env
	then
        spack repo set --destination "${JULEA_SPACK_DIR}/packages" builtin
		spack config --scope site add 'concretizer:reuse:false'
		spack config --scope site add 'config:connect_timeout:60'
		# FIXME We currently need this for JULEA to find all dependencies
		# TODO Is this still needed?
		spack config --scope site add 'modules:prefix_inspections:lib:[LD_LIBRARY_PATH]'
		spack config --scope site add 'modules:prefix_inspections:lib64:[LD_LIBRARY_PATH]'

		if test -n "${CI}"
		then
			spack config --scope site add 'packages:all:target:[x86_64]'
			spack compiler find
			spack compiler list

			if test -n "${JULEA_SPACK_COMPILER}"
			then
				# This should fail if Spack does not recognize the compiler
				spack compiler info "${JULEA_SPACK_COMPILER}"
			fi
		fi

		if test -n "${JULEA_SPACK_COMPILER}"
		then
			spack config --scope site add "packages:all:require:\"%${JULEA_SPACK_COMPILER}\""
		fi

        spack mark --implicit --all

        echo "Installing Spack packages"
        SELF_PATH="$(readlink --canonicalize-existing -- "$0")"
        SELF_DIR="${SELF_PATH%/*}"
        spack env activate "${SELF_DIR}/.."
        spack env status
        spack install --fail-fast --deprecated

        spack gc --yes-to-all

		if test -n "${CI}"
		then
			spack clean --downloads
			spack find
		fi
	fi
}
