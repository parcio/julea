#!/usr/bin/env /Rscript

suppressMessages(library(ggplot2))
suppressMessages(library(dplyr))
suppressMessages(library(scales))
suppressMessages(library(ggpubr))

options(knitr.kable.NA = "")

first_round <- TRUE
last_frame <- NA

# test if all records of the same backend kind (object,kv,db)
# have executed the same order of commands
test_validity <- function(data) {
  res <- TRUE
  data <- subset(
    data,
    select = -c(time, process_uid, program_name, bson, duration)) # nolint: object_usage_linter, line_length_linter.
  for (x in  unique(data$backend)) {
    first_round <<- TRUE
    check <- function(frame, key) {
      if (res == FALSE) {
        return()
      }
      frame <- frame %>% subset(select = -c(backend)) # nolint: object_usage_linter, line_length_linter.
      if (first_round != TRUE) {
        if (nrow(frame) != nrow(last_frame)) {
          warning("number error, the number of accesses differ between runs")
          res <<- FALSE
         } else if (!Reduce(f = "&", x = frame == last_frame)) {
          warning("value error, the access type between runs differ")
          res <<- FALSE
        }
      }
      first_round <<- FALSE
      last_frame <<- frame
    }
    data %>% filter(backend == x) %>% group_by(type, path) %>% group_walk(check) # nolint: object_usage_linter, line_length_linter.
  }
  return(res)
}


args <- commandArgs(trailingOnly = TRUE)
if (length(args) < 1) {
  stop(
    paste(
      "usage:",
      "script", # TODO check if script name can be determined
      "<summary.csv> <- generated by decission-support.sh",
      "[(print|html)] <- output as simple print(default) or as html", sep="\n"),
    call. = FALSE)
}

data <- read.csv(args[1])
as_html <- length(args) >= 2 & args[2] == "html"

res <- test_validity(data)
if (res == FALSE) {
  stop(
    "Access reports between different configurations are not consistent!",
    call. = FALSE)
}

plot_durations <- function(data, key,...,format="simple") {
  # check and convert duration unit as sensible
  unit <- "s"
  if (max(data$duration) < 10.) {
    data$duration <- data$duration * 1000.
    unit <- "ms"
  }
  label <- labs(y = paste0("time in ", unit), fill = "backend", x = "")

  # generate shorted backend label
  confs <-  unique(data %>% select("type", "path"))
  map <- apply(
    confs, 1,
    function(x) paste(x[1], if (sum(confs == x[1]) > 1) x[2] else ""))
  names(map) <- paste0(confs$type, confs$path)
  data$backend <- map[paste0(data$type, data$path)]

  # analyse for runtime per operation type
  sepperate_data <- data %>%
    group_by(backend, operation) %>%
    summarise(duration = sum(duration), cnt = n(), .groups = "drop")
  # plotting
  seperate <- ggplot(sepperate_data,
      aes(y = duration, x = paste(operation, "\n#", cnt), fill = backend)) +
    geom_col(position = "dodge") +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_text(angle = 45)) +
    label
  # table
  sepperate_data <- sepperate_data %>%
    group_by(operation) %>%
    group_modify(function(df, keys) {
      df$speed_up_rel <- max(df$duration) / df$duration
      df$speed_up_abs <- max(df$duration) - df$duration
      df <- df %>% arrange(duration) %>% add_row(.before=0)
      return(df)}) %>%
    ungroup()
  sepperate_data$operation <- reorder(factor(sepperate_data$operation), sepperate_data$speed_up_abs, FUN=max, decreasing=TRUE, na.rm = TRUE)
  sepperate_data <- arrange(sepperate_data, operation)
  sepperate_data[! is.na(sepperate_data$duration),]$operation = NA

  # analyse for total runtime
  total_data <- data %>%
    group_by(backend) %>%
    summarise(duration = sum(duration), .groups = "drop")
  # plotting
  total <- ggplot(total_data,
      aes(y = duration, x = "all operations", fill = backend)) +
    geom_col(position = "dodge") +
    label
  # table
  total_data$speed_up_rec <- max(total_data$duration) / total_data$duration
  total_data$speed_up_abs <- max(total_data$duration) - total_data$duration

  # output table
  plot_file_name <- paste(key[1], "time.svg", sep = "_")
  table_sepperate_str <- knitr::kable(sepperate_data, format, digits=2)
  table_total_str <- knitr::kable(total_data, format, digits=2)
  if (format == "html") {
    cat("<h3 id=\"",as.character(key[1]),"\">",as.character(key[1]),"</h3>", sep = "")
    cat("<table><tbody><tr><td rowspan=\"2\">",table_sepperate_str,"</td><td>", table_total_str,"</td></tr><tr><td><img src=\"./", plot_file_name,"\" alt=\"barplot of results listed in table\"></td></tr></tbody></table>", sep = "")
  } else {
    cat(as.character(key[1]), paste0("plot: ", plot_file_name), "", table_total_str, "", table_sepperate_str, "", "", sep="\n")
  }

  # combining plots and store them
  plot <- ggarrange(seperate, total,
    widths = c(4, 1), ncol = 2, nrow = 1,
    common.legend = TRUE, legend = "bottom")
  ggsave(plot_file_name, plot,
    unit = "in", width = 11, height = 6, bg = "white")
}

# print html header
if (as_html) {
  cat("<!DOCTYPE html><html lang=\"en\"><body><ul>")
  for ( backend in unique(data$backend)) {
    cat("<li><a href=\"#",backend,"\">", backend,"</a></li>", sep="")
  }
  cat("</ul>")
}

data %>% group_by(backend) %>% group_walk(plot_durations, format=if(as_html) "html" else "simple")

# print html closing
if (as_html) {
  cat("</body></html>")
}
